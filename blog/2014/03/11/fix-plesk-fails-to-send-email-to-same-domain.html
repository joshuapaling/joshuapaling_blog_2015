
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
  <title>Joshua Paling  - Fix - Plesk fails to send email to same domain</title>
  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  <link href="../../../../stylesheets/application-650b1803.css" rel="stylesheet" />
  <script src="../../../../javascripts/application-8d565278.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
</head>
<body>
  <div class="page-wrapper">
    <header>
      <h1>Joshua Paling</h1>
      <nav>
        <a class="active" href="/">Blog</a>
        <a class="" href="/about.html">About</a>
        <a class="" href="/resume.html">Resume</a>
        <a href="../../../../feed.xml">RSS</a>
        <a target="_blank" href="https://twitter.com/joshuapaling">@joshuapaling</a>
      </nav>
    </header>


<p>I came across an issue where the server would send email fine, except if it was sending the email to the same domain as the website it was being sent from (eg. sending from the www.clientsdomain.com.au website to info@clientsdomain.com.au or similar). It wasn't the first time I've come across the issue, and also wasn't the first time I've forgotten what the fix was.</p>

<p>Turns out the problem is that, when an email server is enabled on the domain, it thinks it can deliver the email locally, without leaving the server. This is often not the case - eg. your emails might be hosted elsewhere, such as with Google Apps. If your emails <em>are</em> hosted elsewhere, then the attempt to deliver the email (using the local method) fails.</p>

<h3 id="just-diable-the-local-mail-server">Just diable the local mail server</h3>

<p>The solution is simply to disable the local mail server for that domain. There's various ways to do that, depending on your set up. Running Plesk 11, I had to ssh in and execute <code>/usr/local/psa/bin/domain -u yourdomainname.com -mail_service false</code>. But the solution will differ depending on if you're using Plesk, cPanel, etc, depending on what version you're using, etc. Turning local mail off isn't the trickiest / most annoying part, though.</p>

<h3 id="testing-to-ensure-plesk-local-mail-is-in-fact-disabled">Testing to ensure Plesk local mail is in fact disabled</h3>

<p>The most annoying part is <em>testing</em> to ensure that it has been turned off successfully. In my case, I was testing a client website, and really didn't want to have to call the client up and check whether they'd recieved an email, each time I tested. So instead I told them to ignore the test emails, and I did the following:</p>

<h3 id="set-up-a-test-url-that-sends-an-email">Set up a test URL that sends an email</h3>
<p>First, set up a function that sends a single email to two addresses - one on the same somain, one on a different domain (eg. your own email address). Now, you can easily test sending an email, and can also easily check that it at least works for emails <em>not</em> on the same domain.</p>

<h3 id="check-the-mail-logs">Check the mail logs</h3>
<p>Now, after each time you test, check the mail logs. For me, using Plesk 11, they were at <code>/usr/local/psa/var/log/maillog</code>.</p>

<p>You can download them to your desktop and open them in your own text editor with something like:</p>

<p><code>scp username@yourserver:/usr/local/psa/var/log/maillog ~/Desktop/mail_log</code></p>

<p>or, you can ssh into your server and tail them:</p>

<p><code>tail -n 60 /usr/local/psa/var/log/maillog</code></p>

<p>Lines get added to that log pretty quickly, so make sure to tail more than the default 10 lines. (<em>we tail 60 lines with the above command</em>)</p>

<p>Now, search for the results of your test email. If it's still <strong>failing</strong> and using the local mail servers, you should be able to find lines that look like the below. Note the 'problem' email in this example is <em>info@clientsdomain.com.au</em>, and your own 'non-problem' email is <em>you@gmail.com</em>. Note <code>local-handlers</code> versus <code>remote-handlers</code>. You can see below that it's still trying to use the local mail server to deliver to the problem address. This means you're still in trouble:</p>

<pre><code class="language-markup">qmail-remote-handlers[15670]: Handlers Filter before-remote for qmail started ...
qmail-local-handlers[15669]: Handlers Filter before-local for qmail started ...
qmail-local-handlers[15669]: from=anonymous@yourserver.com
qmail-remote-handlers[15670]: from=anonymous@yourserver.com
qmail-remote-handlers[15670]: to=you@gmail.com
qmail-local-handlers[15669]: to=info@clientsdomain.com.au
</code></pre>

<p>Once you successfully turn local mail off, there'll be no more references to <code>local-handlers</code> and they'll instead be replaced with <code>remote-handlers</code>:</p>

<pre><code class="language-markup">qmail-remote-handlers[17990]: Handlers Filter before-remote for qmail started ...
qmail-remote-handlers[17991]: Handlers Filter before-remote for qmail started ...
qmail-remote-handlers[17991]: from=anonymous@yourserver.com
qmail-remote-handlers[17991]: to=info@clientsdomain.com.au
qmail-remote-handlers[17990]: from=anonymous@yourserver.com
qmail-remote-handlers[17990]: to=you@gmail.com
</code></pre>

<h3 id="its-working">It's working!</h3>

<p>Once you get log output looking like the above, you know it should be sending the email to your client correctly! Yay! Call them to confirm it isn't ending up in their spam or anything.</p>

<p>This example was for Plesk version 11, but the concepts should be transferable.</p>

<h3 id="and-by-the-way">And by the wayâ€¦</h3>

<p>A good time to check this is before (or immediately after) launch - not 6 months later when the client finally seems to realise they have't recieved any enquiries through the website, ever. (<em>Yep, this has happened to me, more than once, despite the fact I <strong>always</strong> insist they test multiple times, after the site goes live. And the fact that I send them a test, and ask them to reply to confirm.</em>)</p>


    <!-- Footer -->
    <footer>
      <nav>
        <a class="active" href="/">Blog</a>
        &nbsp;&bull;&nbsp;
        <a class="" href="/about.html">About</a>
        &nbsp;&bull;&nbsp;
        <a class="" href="/resume.html">Resume</a>
        &nbsp;&bull;&nbsp;
        <a href="../../../../feed.xml">RSS</a>
        &nbsp;&bull;&nbsp;
        <a class="" href="/archives.html">Archives</a>
      </nav>
      <div class="row">
        <div class="col-lg-12">
          <p>Copyright &copy; Joshua Paling 2015</p>
        </div>
      </div>
      <!-- /.row -->
    </footer>

  </div>

</body>
</html>

