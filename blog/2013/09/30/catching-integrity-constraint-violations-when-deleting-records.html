
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
  <title>Joshua Paling  - CakePHP - Catching integrity constraint violations when deleting records</title>
  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  <link href="../../../../stylesheets/application-3a039e88.css" rel="stylesheet" />
  <script src="../../../../javascripts/application-547ab8eb.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
</head>
<body>
  <div class="page-wrapper">
    <header>
      <h1>Joshua Paling</h1>
      <nav>
        <a class="active" href="/">Blog</a>
        <a class="" href="/about.html">About</a>
        <a class="" href="/resume.html">Resume</a>
        <a href="../../../../feed.xml">RSS</a>
        <a target="_blank" href="https://twitter.com/joshuapaling">@joshuapaling</a>
      </nav>
    </header>


<p>In a CakePHP app, if you’ve done the right thing and defined your Model associations at the database level (ie, if you’ve added foreign key indexes to all the relevant fields in every table), then you might come across errors when deleting records… something like this:</p>

<pre><code class="language-markup">SQLSTATE[23000]: INTEGRITY CONSTRAINT VIOLATION: 1451 CANNOT DELETE OR UPDATE A PARENT ROW: A FOREIGN KEY CONSTRAINT FAILS
</code></pre>

<p>You’ll want to catch that exception yourself, and ideally, display it nicely for your users.</p>

<p>Here’s a quick method I wrote for <code>AppModel.php</code> that should do the trick. On the <code>beforeDelete</code> callback, it’ll loop through the model’s <code>$hasMany</code> associations, and for any that aren’t listed as <code>'dependent' =&gt; true</code>, it’ll check for linked records, and throw an exception if it finds any.</p>

<p>(Of course, <code>'dependent' =&gt; true</code> cases can be ignored, since those associated records will get deleted automatically)</p>

<p>Say you were deleting a Category that had Items, the exception message will look something like this:</p>

<pre><code class="language-markup">THERE ARE ITEMS LINKED TO THIS RECORD.
</code></pre>

<p>So, here’s the code to put in <code>AppModel.php</code>:</p>

<pre><code class="language-php">&lt;?php
public function beforeDelete($cascade = true) {
 $canDelete = true;
 foreach ($this-&gt;hasMany as $model =&gt; $details) {
 	if ($details['dependent'] !== true ) {
   if ($details['className'] == $this-&gt;name) {
    $ModelInstance = $this;
   } else {
    $ModelInstance = $this-&gt;{$details['className']};
   }
   $count = $ModelInstance-&gt;find("count", array(
    "conditions" =&gt; array($details['foreignKey'] =&gt; $this-&gt;id)
   ));
   if ($count) {
    throw new Exception( sprintf("There are %s linked to this record.", strtolower(Inflector::humanize(Inflector::tableize($model)))) );
   }
   if ($count &gt; 0) {
    $canDelete = false;
   }
 	}
 }

 return $canDelete;
}
</code></pre>

<p>And here’s what the relevant snipped might look like in your controller:</p>

<pre><code class="language-php">&lt;?php
try {
 if ($this-&gt;MyModel-&gt;delete()) {
 	$this-&gt;Session-&gt;setFlash('Record deleted', 'default', array(), 'good');
 } else {
 	$this-&gt;Session-&gt;setFlash('Record was not deleted. Unknown error.', 'default', array(), 'bad');
 }
} catch (Exception $e) {
 $this-&gt;Session-&gt;setFlash("Delete failed. {$e-&gt;getMessage()}", 'default', array(), 'bad');
}
return $this-&gt;redirect(array('action' =&gt; 'index'));

</code></pre>


    <!-- Footer -->
    <footer>
      <nav>
        <a class="active" href="/">Blog</a>
        &nbsp;&bull;&nbsp;
        <a class="" href="/about.html">About</a>
        &nbsp;&bull;&nbsp;
        <a class="" href="/resume.html">Resume</a>
        &nbsp;&bull;&nbsp;
        <a href="../../../../feed.xml">RSS</a>
        &nbsp;&bull;&nbsp;
        <a class="" href="/archives.html">Archives</a>
      </nav>
      <div class="row">
        <div class="col-lg-12">
          <p>Copyright &copy; Joshua Paling 2015</p>
        </div>
      </div>
      <!-- /.row -->
    </footer>

  </div>

</body>
</html>

