
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
  <title>Joshua Paling </title>
  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  <link href="../stylesheets/application-650b1803.css" rel="stylesheet" />
  <script src="../javascripts/application-8d565278.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
</head>
<body>
  <div class="page-wrapper">
    <header>
      <h1>Joshua Paling</h1>
      <nav>
        <a class="" href="/">Blog</a>
        <a class="" href="/about.html">About</a>
        <a class="" href="/resume.html">Resume</a>
        <a href="../feed.xml">RSS</a>
        <a target="_blank" href="https://twitter.com/joshuapaling">@joshuapaling</a>
      </nav>
    </header>


<h1>Sequelize</h1>

<pre><code>sequelize db:migrate
sequelize db:migrate:undo
sequelize db:migrate:undo:all
</code></pre>

<p><a href="http://docs.sequelizejs.com/en/latest/docs/migrations/">http://docs.sequelizejs.com/en/latest/docs/migrations/</a></p>

<p>new migration: <code>sequelize migration:create</code> (name it after creating it)</p>

<p>Example migration:</p>

<pre><code class="language-javascript">module.exports = {
  up: function(queryInterface, Sequelize) {
    return queryInterface.createTable('clusters', {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: Sequelize.BIGINT
      },
      other_table_id: {
        type: Sequelize.BIGINT,
        allowNull: false,
        references: {
          model: 'clusters',
          key: 'id'
        },
        onUpdate: 'cascade',
        onDelete: 'cascade'
      },
      code: {
        allowNull: false,
        type: Sequelize.STRING,
        unique: true,
      },
      name: {
        allowNull: false,
        type: Sequelize.STRING
      },
      topojson: {
        allowNull: true,
        type: Sequelize.TEXT
      },
      created_at: {
        allowNull: false,
        type: Sequelize.DATE
      },
      updated_at: {
        allowNull: false,
        type: Sequelize.DATE
      }
    }).then(() =&gt; queryInterface.addIndex(
      'scenario_school_years',
      ['scenario_id', 'school_code', 'school_year'],
      {
        indexName: 'unique_scenario_school_years',
        indicesType: 'UNIQUE'
      }
    ))
  },
  down: function(queryInterface, Sequelize) {
    return queryInterface.dropTable('clusters')
  }
}

</code></pre>

<h2 id="rename-table">Rename table:</h2>

<pre><code class="language-javascript">'use strict';

module.exports = {
  up: function (queryInterface, Sequelize) {
    return queryInterface.renameTable('old_name', 'new_name')
  },

  down: function (queryInterface, Sequelize) {
    return queryInterface.renameTable('new_name', 'old_name')
  }
};
</code></pre>

<h2 id="rename-column">Rename column:</h2>

<pre><code class="language-javascript">'use strict';

module.exports = {
  up: function (queryInterface, Sequelize) {
    return queryInterface.renameColumn('scenarios', 'old_name', 'new_name')
  },

  down: function (queryInterface, Sequelize) {
    return queryInterface.renameColumn('scenarios', 'new_name', 'old_name')
  }
};
</code></pre>

<h2 id="add-column">Add column:</h2>

<pre><code class="language-javascript">'use strict';

module.exports = {
  up: function (queryInterface, Sequelize) {
    return queryInterface.addColumn(
      'scenarios',
      'azure_job_status',
      {
        allowNull: false,
        defaultValue: '',
        type: Sequelize.STRING,
        comment: "The status of azure_job_id from Azure's machine learning"
      }
    )
  },

  down: function (queryInterface, Sequelize) {
    return queryInterface.removeColumn('scenarios', 'azure_job_status')
  }
};
</code></pre>

<h2 id="change-column">Change column:</h2>

<pre><code class="language-javascript">'use strict';

module.exports = {
  up: function (queryInterface, Sequelize) {
    return queryInterface.changeColumn(
      'schools',
      'meshblock_code',
      {
        type: Sequelize.BIGINT,
        allowNull: true,
        references: {
          model: 'meshblocks',
          key: 'meshblock_code'
        },
        onUpdate: 'cascade',
        onDelete: 'cascade'
      }
    )
  },

  down: function (queryInterface, Sequelize) {
    return queryInterface.changeColumn(
      'schools',
      'meshblock_code',
      {
        type: Sequelize.BIGINT,
        allowNull: true,
      }
    )
  }
};

</code></pre>

<h2 id="execute-some-sql">Execute some SQL:</h2>

<pre><code class="language-javascript">'use strict';

module.exports = {
  up: function (queryInterface, Sequelize) {
    return queryInterface.sequelize.query("insert into settings (setting_key, setting_value) values ('power_bi_url', 'https://app.powerbi.com/groups/3721a85d-41c6-45e9-8a65-2669ee462b47/dashboards/3eeed953-09a6-4713-bf8c-66ec46b8af56')")
  },

  down: function (queryInterface, Sequelize) {
    return queryInterface.sequelize.query("delete from settings where setting_key = 'power_bi_url'")
  }
};

</code></pre>

<h2 id="execute-some-other-code-to-update-records-in-a-migration-using-model-classes">Execute some other code to update records in a migration, using model classes:</h2>

<pre><code class="language-javascript">'use strict';
const models = require('../models');
const Promise = require('bluebird');
const interventionCrud = require('../modules/interventionCrud');

module.exports = {
  up: async function(queryInterface, Sequelize) {
    // Find all interventions and calcDerivedInterventionFields
    const interventions = await models.intervention.findAll();
    // Updating with no changes will re-calc all derived fields
    await Promise.map(interventions, i =&gt; interventionCrud.update(i.id, {}));
  },

  down: function(queryInterface, Sequelize) {
    /*
      Intentionally blank
    */
  },
};

</code></pre>

<h2 id="create-new-record">Create new record</h2>

<pre><code class="language-javascript">yield models.scenario_meshblock_result.create({
  result_year: 2016,
  meshblock_code: '1234',
  school_code: '10011670000',
  scenario_id: scenario.id,
  allocated_students: 100,
})
</code></pre>

<h1 id="find-docohttpdocssequelizejscomenlatestapimodelfindalloptions-promisearrayinstance"><a href="http://docs.sequelizejs.com/en/latest/api/model/#findalloptions-promisearrayinstance">find doco</a></h1>

<h2 id="find-one">Find one</h2>

<pre><code class="language-javascript">const baseScenario = yield models.scenario.findOne({ where: { cluster_id: cluster.id, type }})
</code></pre>

<h2 id="find-all">Find all</h2>

<pre><code class="language-javascript">const clusters = yield models.cluster.findAll()
</code></pre>

<pre><code class="language-javascript">const Op = models.Sequelize.Op;
const scenarios = await models.scenario.findAll({
  where: { id: { [Op.in]: ids } },
  include: [
    { model: models.cluster },
    {
      model: models.school,
      include: [models.intervention],
    },
  ],
});
</code></pre>


    <!-- Footer -->
    <footer>
      <nav>
        <a class="" href="/">Blog</a>
        &nbsp;&bull;&nbsp;
        <a class="" href="/about.html">About</a>
        &nbsp;&bull;&nbsp;
        <a class="" href="/resume.html">Resume</a>
        &nbsp;&bull;&nbsp;
        <a href="../feed.xml">RSS</a>
        &nbsp;&bull;&nbsp;
        <a class="" href="/archives.html">Archives</a>
      </nav>
      <div class="row">
        <div class="col-lg-12">
          <p>Copyright &copy; Joshua Paling 2015</p>
        </div>
      </div>
      <!-- /.row -->
    </footer>

  </div>

</body>
</html>

